

ðŸ“„ Rancangan Sistem Manajemen Stok Gudang
1. Gambaran Umum
Sistem ini dirancang untuk mendukung manajemen stok gudang lintas perusahaan dengan fitur yang lengkap mulai dari penerimaan barang, pemindahan antar gudang, penjualan ke pelanggan/konsumen, hingga proses retur.

Aplikasi akan dikembangkan menggunakan CodeIgniter 3.1.13 dengan tampilan berbasis SB Admin 2 (Bootstrap 4), serta database MySQL.

2. Fitur Utama
2.1 Multi Perusahaan
    a. Sistem mendukung banyak perusahaan sekaligus.
    b. Data dipisahkan berdasarkan perusahaan (barang, gudang, pelanggan, supplier, stok).

2.2 Manajemen Hak Akses (Role-Based Access)
Hak akses diatur berdasarkan role:
    1. Super Admin â†’ mengelola semua perusahaan.
    2. Admin Perusahaan â†’ mengelola seluruh data dan transaksi dalam lingkup perusahaannya.
    3. Sales Online â†’ melakukan input penjualan ke konsumen, tidak menyimpan stok.
    4. Admin Packing â†’ menangani proses packing, pengiriman, dan konfirmasi barang sampai.
    5. Admin Return â†’ memproses verifikasi dan approval retur barang.

3. Fitur Transaksi
3.1 Pemindahan Barang
Pemindahan barang bisa berupa:
    1. Gudang â†’ Gudang lain (internal transfer).
    2. Gudang â†’ Pelanggan (distributor resmi).
    3. Gudang â†’ Konsumen (melalui penjualan oleh Sales).
Catatan: Sales tidak memiliki stok. Barang tetap diambil dari gudang.

Alur Status Pemindahan:
    a. Draft â†’ transaksi baru dibuat.
    b. Packing â†’ barang sedang diproses untuk dikemas.
    c. Shipping â†’ barang dalam proses pengiriman, stok gudang sudah dikurangi.
    d. Delivered â†’ barang diterima tujuan, transaksi selesai.
    e. Cancelled â†’ pemindahan dibatalkan (stok dikembalikan jika sudah dikurangi).

3.2 Penerimaan Barang
    a. Input nomor penerimaan (berdasarkan supplier).
    b. Input detail barang yang masuk ke gudang.

Alur Status Penerimaan:
    a. Draft â†’ data penerimaan dibuat.
    b. Received â†’ barang sudah dicatat masuk, stok gudang bertambah.
    c. Completed â†’ penerimaan selesai diproses.
    d. Cancelled â†’ penerimaan dibatalkan.

3.3 Retur Barang
Terdapat dua jenis retur:
    1. Retur Penjualan â†’ retur barang dari pelanggan/konsumen.
    2. Retur Pembelian â†’ retur barang ke supplier.

Alur Status Retur:
    a.Requested â†’ retur diajukan.
    b.Verification â†’ barang diperiksa oleh Admin Return.
    c.Approved â†’ retur diterima, stok gudang bertambah (untuk retur penjualan) atau berkurang (untuk retur pembelian).
    d. Rejected â†’ retur ditolak, tidak ada perubahan stok.
    e.Completed â†’ retur selesai diproses.

4. Menu Setup
    1. Kategori â†’ master data kategori barang (per perusahaan).
    2. Barang â†’ master data barang (relasi ke perusahaan & kategori).
    3. Gudang â†’ daftar gudang per perusahaan.
    4. Sales â†’ user dengan role Sales Online.
    5. Packing â†’ user dengan role Admin Packing.
    6. Pelanggan â†’ distributor resmi per perusahaan.
    7. Supplier â†’ pemasok per perusahaan.

5. Menu Laporan
    1. Laporan Sales â†’ detail penjualan ke konsumen/pelanggan.
    2. Laporan Packing â†’ aktivitas pengiriman & pekerjaan Admin Packing.
    3. Laporan Mutasi â†’ pergerakan barang antar gudang & transaksi keluar/masuk.
    4. Laporan Summary â†’ ringkasan stok masuk, keluar, dan saldo akhir.

6. Catatan Implementasi
    1. Frontend: SB Admin 2 + Bootstrap 4, untuk dashboard dan tampilan responsive.
    2. Backend: CodeIgniter 3.1.13 dengan pemisahan layer (Controller, Model, View).
    3. Database: MySQL dengan pencatatan semua pergerakan barang di tabel log_stok.
    4. Audit Trail: setiap perubahan stok dicatat berdasarkan user yang melakukan aksi.
    5. Approval Flow: pemindahan dan retur mengacu pada alur status agar setiap transaksi terkontrol.

ðŸ‘‰ Jadi sistem ini tidak hanya mencatat stok keluar-masuk, tapi juga memastikan setiap proses memiliki status & approval yang jelas. Hal ini penting untuk tracking, akurasi stok, dan transparansi antar peran dalam perusahaan.


database sementara yang dimiliki seperti ini,
namun seperti nya ini tidak mengcover semuanya yang kita butuhkan,
jadi tolong perbaiki desain database nya ya bro
-- Create Tables
CREATE TABLE `role_user` (
  `id_role` int(11) NOT NULL AUTO_INCREMENT,
  `nama_role` varchar(50) NOT NULL,
  `deskripsi` text DEFAULT NULL,
  PRIMARY KEY (`id_role`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `user` (
  `id_user` int(11) NOT NULL AUTO_INCREMENT,
  `nama` varchar(100) NOT NULL,
  `username` varchar(50) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `id_role` int(11) NOT NULL,
  `id_perusahaan` int(11) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `telepon` varchar(20) DEFAULT NULL,
  `created_by` int(11) DEFAULT NULL,
  `aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT NULL,
  `last_login` datetime DEFAULT NULL,
  `foto_profil` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id_user`),
  UNIQUE KEY `username` (`username`),
  KEY `id_role` (`id_role`),
  KEY `id_perusahaan` (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `perusahaan` (
  `id_perusahaan` int(11) NOT NULL AUTO_INCREMENT,
  `nama_perusahaan` varchar(255) NOT NULL,
  `alamat` varchar(255) DEFAULT NULL,
  `telepon` varchar(20) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `gudang` (
  `id_gudang` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `nama_gudang` varchar(100) NOT NULL,
  `alamat` text DEFAULT NULL,
  `telepon` varchar(20) DEFAULT NULL,
  `created_by` int(11) DEFAULT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id_gudang`),
  KEY `id_perusahaan` (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `kategori` (
  `id_kategori` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `nama_kategori` varchar(50) NOT NULL,
  `deskripsi` text DEFAULT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_kategori`),
  UNIQUE KEY `uniq_kategori_perusahaan` (`id_perusahaan`,`nama_kategori`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `barang` (
  `id_barang` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `id_kategori` int(11) DEFAULT NULL,
  `nama_barang` varchar(100) NOT NULL,
  `gambar` varchar(255) DEFAULT NULL,
  `sku` varchar(50) NOT NULL,
  `deskripsi` text DEFAULT NULL,
  `satuan` varchar(20) DEFAULT NULL,
  `harga_jual` decimal(10,2) DEFAULT NULL,
  `harga_beli_terakhir` decimal(10,2) DEFAULT NULL,
  `aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_barang`),
  UNIQUE KEY `uniq_sku_perusahaan` (`id_perusahaan`,`sku`),
  KEY `id_kategori` (`id_kategori`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `supplier` (
  `id_supplier` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `nama_supplier` varchar(100) NOT NULL,
  `alamat` text DEFAULT NULL,
  `telepon` varchar(20) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `kontak_person` varchar(100) DEFAULT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_supplier`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `pelanggan` (
  `id_pelanggan` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `nama_pelanggan` varchar(100) NOT NULL,
  `alamat` text DEFAULT NULL,
  `telepon` varchar(20) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `tipe_pelanggan` enum('distributor','konsumen') DEFAULT 'konsumen',
  `status_aktif` tinyint(1) DEFAULT 1,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_pelanggan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `stok_gudang` (
  `id_stok` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `jumlah` int(11) NOT NULL DEFAULT 0,
  `reserved` int(11) NOT NULL DEFAULT 0 COMMENT 'Jumlah stok yang dipesan tapi belum dikirim',
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_stok`),
  UNIQUE KEY `uniq_barang_gudang` (`id_barang`,`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `stok_awal` (
  `id_stok_awal` int(11) NOT NULL AUTO_INCREMENT,
  `id_barang` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `id_perusahaan` int(11) NOT NULL,
  `qty_awal` int(11) NOT NULL,
  `keterangan` text DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  `created_by` int(11) NOT NULL,
  PRIMARY KEY (`id_stok_awal`),
  KEY `fk_stok_awal_barang` (`id_barang`),
  KEY `fk_stok_awal_gudang` (`id_gudang`),
  KEY `fk_stok_awal_perusahaan` (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `pembelian` (
  `id_pembelian` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `no_pembelian` varchar(50) DEFAULT NULL,
  `id_user` int(11) NOT NULL,
  `id_supplier` int(11) DEFAULT NULL,
  `tanggal_pembelian` datetime NOT NULL,
  `tanggal_estimasi` datetime DEFAULT NULL,
  `keterangan` text DEFAULT NULL,
  `status` enum('Draft','Received','Completed','Cancelled') DEFAULT 'Draft',
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_pembelian`),
  KEY `id_perusahaan` (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_pembelian` (
  `id_detail` int(11) NOT NULL AUTO_INCREMENT,
  `id_pembelian` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `jumlah` int(11) NOT NULL,
  `harga_beli` decimal(10,2) DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail`),
  KEY `id_pembelian` (`id_pembelian`),
  KEY `id_barang` (`id_barang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `penerimaan_barang` (
  `id_penerimaan` int(11) NOT NULL AUTO_INCREMENT,
  `no_penerimaan` varchar(50) DEFAULT NULL,
  `id_pembelian` int(11) DEFAULT NULL,
  `id_user` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `tanggal_penerimaan` datetime NOT NULL,
  `keterangan` text DEFAULT NULL,
  `status` enum('Draft','Received','Completed','Cancelled') DEFAULT 'Draft',
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_penerimaan`),
  KEY `id_pembelian` (`id_pembelian`),
  KEY `id_user` (`id_user`),
  KEY `id_gudang` (`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_penerimaan` (
  `id_detail` int(11) NOT NULL AUTO_INCREMENT,
  `id_penerimaan` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `jumlah_diterima` int(11) NOT NULL,
  `jumlah_dipesan` int(11) DEFAULT NULL,
  `id_gudang` int(11) NOT NULL,
  `keterangan` text DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail`),
  KEY `id_penerimaan` (`id_penerimaan`),
  KEY `id_barang` (`id_barang`),
  KEY `id_gudang` (`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `penjualan` (
  `id_penjualan` int(11) NOT NULL AUTO_INCREMENT,
  `id_perusahaan` int(11) NOT NULL,
  `no_invoice` varchar(50) DEFAULT NULL,
  `id_user` int(11) NOT NULL,
  `id_pelanggan` int(11) DEFAULT NULL,
  `tanggal_penjualan` datetime NOT NULL,
  `keterangan` text DEFAULT NULL,
  `status` enum('Draft','Packing','Shipping','Delivered','Cancelled') DEFAULT 'Draft',
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_penjualan`),
  KEY `id_perusahaan` (`id_perusahaan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_penjualan` (
  `id_detail` int(11) NOT NULL AUTO_INCREMENT,
  `id_penjualan` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `jumlah` int(11) NOT NULL,
  `harga_jual` decimal(10,2) DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail`),
  KEY `fk_penjualan_detail` (`id_penjualan`),
  KEY `fk_barang_penjualan` (`id_barang`),
  KEY `fk_gudang_penjualan` (`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `retur_penjualan` (
  `id_retur` int(11) NOT NULL AUTO_INCREMENT,
  `no_retur` varchar(50) DEFAULT NULL,
  `id_penjualan` int(11) NOT NULL,
  `id_user` int(11) NOT NULL,
  `tanggal_retur` datetime NOT NULL,
  `alasan_retur` text NOT NULL,
  `status` enum('Requested','Verification','Approved','Rejected','Completed') DEFAULT 'Requested',
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_retur`),
  KEY `id_penjualan` (`id_penjualan`),
  KEY `id_user` (`id_user`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_retur_penjualan` (
  `id_detail_retur` int(11) NOT NULL AUTO_INCREMENT,
  `id_retur` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `jumlah_retur` int(11) NOT NULL,
  `alasan_barang` text DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail_retur`),
  KEY `fk_retur` (`id_retur`),
  KEY `fk_barang` (`id_barang`),
  KEY `fk_gudang` (`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `retur_pembelian` (
  `id_retur_beli` int(11) NOT NULL AUTO_INCREMENT,
  `no_retur_beli` varchar(50) DEFAULT NULL,
  `id_pembelian` int(11) DEFAULT NULL,
  `id_user` int(11) NOT NULL,
  `id_supplier` int(11) NOT NULL,
  `tanggal_retur` datetime NOT NULL,
  `alasan_retur` text NOT NULL,
  `status` enum('Requested','Verification','Approved','Rejected','Completed') DEFAULT 'Requested',
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_retur_beli`),
  KEY `id_pembelian` (`id_pembelian`),
  KEY `id_user` (`id_user`),
  KEY `id_supplier` (`id_supplier`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_retur_pembelian` (
  `id_detail_retur_beli` int(11) NOT NULL AUTO_INCREMENT,
  `id_retur_beli` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `jumlah_retur` int(11) NOT NULL,
  `alasan_barang` text DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail_retur_beli`),
  KEY `id_retur_beli` (`id_retur_beli`),
  KEY `id_barang` (`id_barang`),
  KEY `id_gudang` (`id_gudang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `transfer_stok` (
  `id_transfer` int(11) NOT NULL AUTO_INCREMENT,
  `no_transfer` varchar(50) DEFAULT NULL,
  `id_perusahaan` int(11) NOT NULL,
  `id_gudang_asal` int(11) NOT NULL,
  `id_gudang_tujuan` int(11) NOT NULL,
  `id_user` int(11) NOT NULL,
  `tanggal` datetime NOT NULL,
  `keterangan` varchar(255) DEFAULT NULL,
  `status` enum('Draft','Packing','Shipping','Delivered','Cancelled') DEFAULT 'Draft',
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_transfer`),
  KEY `id_perusahaan` (`id_perusahaan`),
  KEY `id_gudang_asal` (`id_gudang_asal`),
  KEY `id_gudang_tujuan` (`id_gudang_tujuan`),
  KEY `id_user` (`id_user`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_transfer_stok` (
  `id_detail` int(11) NOT NULL AUTO_INCREMENT,
  `id_transfer` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `jumlah` int(11) NOT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail`),
  KEY `id_transfer` (`id_transfer`),
  KEY `id_barang` (`id_barang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `packing` (
  `id_packing` int(11) NOT NULL AUTO_INCREMENT,
  `id_referensi` int(11) NOT NULL COMMENT 'ID dari transaksi terkait (penjualan/transfer)',
  `tipe_referensi` enum('penjualan','transfer') NOT NULL,
  `id_user` int(11) NOT NULL,
  `tanggal_packing` datetime NOT NULL,
  `status` enum('Draft','Packing','Completed','Cancelled') DEFAULT 'Draft',
  `catatan` text DEFAULT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  `updated_at` datetime DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id_packing`),
  KEY `id_referensi` (`id_referensi`),
  KEY `id_user` (`id_user`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `detail_packing` (
  `id_detail` int(11) NOT NULL AUTO_INCREMENT,
  `id_packing` int(11) NOT NULL,
  `id_barang` int(11) NOT NULL,
  `jumlah` int(11) NOT NULL,
  `created_at` datetime DEFAULT current_timestamp(),
  PRIMARY KEY (`id_detail`),
  KEY `id_packing` (`id_packing`),
  KEY `id_barang` (`id_barang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `log_stok` (
  `id_log` int(11) NOT NULL AUTO_INCREMENT,
  `id_barang` int(11) NOT NULL,
  `id_user` int(11) DEFAULT NULL,
  `id_perusahaan` int(11) NOT NULL,
  `id_gudang` int(11) NOT NULL,
  `jenis` enum('masuk','keluar','retur_penjualan','retur_pembelian','transfer_keluar','transfer_masuk','penyesuaian') NOT NULL,
  `jumlah` int(11) NOT NULL,
  `sisa_stok` int(11) NOT NULL,
  `keterangan` text DEFAULT NULL,
  `tanggal` datetime DEFAULT current_timestamp(),
  `id_referensi` int(11) DEFAULT NULL COMMENT 'ID transaksi terkait (penjualan/penerimaan/retur/transfer)',
  `tipe_referensi` enum('penjualan','penerimaan','retur_penjualan','retur_pembelian','transfer','penyesuaian') DEFAULT NULL,
  PRIMARY KEY (`id_log`),
  KEY `idx_barang` (`id_barang`),
  KEY `idx_gudang` (`id_gudang`),
  KEY `idx_perusahaan` (`id_perusahaan`),
  KEY `idx_referensi` (`id_referensi`),
  KEY `idx_tipe_referensi` (`tipe_referensi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `log_status_transaksi` (
  `id_log` int(11) NOT NULL AUTO_INCREMENT,
  `id_transaksi` int(11) NOT NULL,
  `tipe_transaksi` enum('penjualan','pembelian','penerimaan','retur_penjualan','retur_pembelian','transfer_stok','packing') NOT NULL,
  `id_user` int(11) NOT NULL,
  `status` varchar(20) NOT NULL,
  `tanggal` datetime NOT NULL DEFAULT current_timestamp(),
  `keterangan` text DEFAULT NULL,
  PRIMARY KEY (`id_log`),
  KEY `id_transaksi` (`id_transaksi`),
  KEY `id_user` (`id_user`),
  KEY `tipe_transaksi` (`tipe_transaksi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `pengaturan_sistem` (
  `id_pengaturan` int(11) NOT NULL AUTO_INCREMENT,
  `key` varchar(50) NOT NULL,
  `value` text DEFAULT NULL,
  `keterangan` text DEFAULT NULL,
  PRIMARY KEY (`id_pengaturan`),
  UNIQUE KEY `uniq_key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `menu` (
  `id_menu` int(11) NOT NULL AUTO_INCREMENT,
  `nama_menu` varchar(50) NOT NULL,
  `url` varchar(100) DEFAULT NULL,
  `icon` varchar(50) DEFAULT NULL,
  `urutan` int(11) DEFAULT 0,
  `id_parent` int(11) DEFAULT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`id_menu`),
  KEY `id_parent` (`id_parent`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `hak_akses_menu` (
  `id_hak_akses` int(11) NOT NULL AUTO_INCREMENT,
  `id_role` int(11) NOT NULL,
  `id_menu` int(11) NOT NULL,
  `akses` tinyint(1) DEFAULT 0,
  PRIMARY KEY (`id_hak_akses`),
  UNIQUE KEY `uniq_role_menu` (`id_role`,`id_menu`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `approval_flow` (
  `id_approval` int(11) NOT NULL AUTO_INCREMENT,
  `tipe_transaksi` enum('penjualan','pembelian','penerimaan','retur_penjualan','retur_pembelian','transfer_stok') NOT NULL,
  `status_dari` varchar(20) NOT NULL,
  `status_ke` varchar(20) NOT NULL,
  `id_role` int(11) NOT NULL,
  `urutan` int(11) NOT NULL,
  `status_aktif` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`id_approval`),
  KEY `tipe_transaksi` (`tipe_transaksi`),
  KEY `id_role` (`id_role`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Add Foreign Keys
ALTER TABLE `user` 
ADD CONSTRAINT `user_ibfk_1` FOREIGN KEY (`id_role`) REFERENCES `role_user` (`id_role`),
ADD CONSTRAINT `user_ibfk_2` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `user_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `user` (`id_user`);

ALTER TABLE `gudang` 
ADD CONSTRAINT `gudang_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `gudang_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `user` (`id_user`);

ALTER TABLE `kategori` 
ADD CONSTRAINT `kategori_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`);

ALTER TABLE `barang` 
ADD CONSTRAINT `barang_ibfk_1` FOREIGN KEY (`id_kategori`) REFERENCES `kategori` (`id_kategori`),
ADD CONSTRAINT `barang_ibfk_2` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`);

ALTER TABLE `supplier` 
ADD CONSTRAINT `supplier_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`);

ALTER TABLE `pelanggan` 
ADD CONSTRAINT `pelanggan_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`);

ALTER TABLE `stok_gudang` 
ADD CONSTRAINT `stok_gudang_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `stok_gudang_ibfk_2` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`),
ADD CONSTRAINT `stok_gudang_ibfk_3` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`);

ALTER TABLE `stok_awal` 
ADD CONSTRAINT `stok_awal_ibfk_1` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `stok_awal_ibfk_2` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`),
ADD CONSTRAINT `stok_awal_ibfk_3` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `stok_awal_ibfk_4` FOREIGN KEY (`created_by`) REFERENCES `user` (`id_user`);

ALTER TABLE `pembelian` 
ADD CONSTRAINT `pembelian_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `pembelian_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`),
ADD CONSTRAINT `pembelian_ibfk_3` FOREIGN KEY (`id_supplier`) REFERENCES `supplier` (`id_supplier`);

ALTER TABLE `detail_pembelian` 
ADD CONSTRAINT `detail_pembelian_ibfk_1` FOREIGN KEY (`id_pembelian`) REFERENCES `pembelian` (`id_pembelian`),
ADD CONSTRAINT `detail_pembelian_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`);

ALTER TABLE `penerimaan_barang` 
ADD CONSTRAINT `penerimaan_barang_ibfk_1` FOREIGN KEY (`id_pembelian`) REFERENCES `pembelian` (`id_pembelian`),
ADD CONSTRAINT `penerimaan_barang_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`),
ADD CONSTRAINT `penerimaan_barang_ibfk_3` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `detail_penerimaan` 
ADD CONSTRAINT `detail_penerimaan_ibfk_1` FOREIGN KEY (`id_penerimaan`) REFERENCES `penerimaan_barang` (`id_penerimaan`),
ADD CONSTRAINT `detail_penerimaan_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `detail_penerimaan_ibfk_3` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `penjualan` 
ADD CONSTRAINT `penjualan_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `penjualan_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`),
ADD CONSTRAINT `penjualan_ibfk_3` FOREIGN KEY (`id_pelanggan`) REFERENCES `pelanggan` (`id_pelanggan`);

ALTER TABLE `detail_penjualan` 
ADD CONSTRAINT `detail_penjualan_ibfk_1` FOREIGN KEY (`id_penjualan`) REFERENCES `penjualan` (`id_penjualan`),
ADD CONSTRAINT `detail_penjualan_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `detail_penjualan_ibfk_3` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `retur_penjualan` 
ADD CONSTRAINT `retur_penjualan_ibfk_1` FOREIGN KEY (`id_penjualan`) REFERENCES `penjualan` (`id_penjualan`),
ADD CONSTRAINT `retur_penjualan_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`);

ALTER TABLE `detail_retur_penjualan` 
ADD CONSTRAINT `detail_retur_penjualan_ibfk_1` FOREIGN KEY (`id_retur`) REFERENCES `retur_penjualan` (`id_retur`),
ADD CONSTRAINT `detail_retur_penjualan_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `detail_retur_penjualan_ibfk_3` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `retur_pembelian` 
ADD CONSTRAINT `retur_pembelian_ibfk_1` FOREIGN KEY (`id_pembelian`) REFERENCES `pembelian` (`id_pembelian`),
ADD CONSTRAINT `retur_pembelian_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`),
ADD CONSTRAINT `retur_pembelian_ibfk_3` FOREIGN KEY (`id_supplier`) REFERENCES `supplier` (`id_supplier`);

ALTER TABLE `detail_retur_pembelian` 
ADD CONSTRAINT `detail_retur_pembelian_ibfk_1` FOREIGN KEY (`id_retur_beli`) REFERENCES `retur_pembelian` (`id_retur_beli`),
ADD CONSTRAINT `detail_retur_pembelian_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `detail_retur_pembelian_ibfk_3` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `transfer_stok` 
ADD CONSTRAINT `transfer_stok_ibfk_1` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `transfer_stok_ibfk_2` FOREIGN KEY (`id_gudang_asal`) REFERENCES `gudang` (`id_gudang`),
ADD CONSTRAINT `transfer_stok_ibfk_3` FOREIGN KEY (`id_gudang_tujuan`) REFERENCES `gudang` (`id_gudang`),
ADD CONSTRAINT `transfer_stok_ibfk_4` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`);

ALTER TABLE `detail_transfer_stok` 
ADD CONSTRAINT `detail_transfer_stok_ibfk_1` FOREIGN KEY (`id_transfer`) REFERENCES `transfer_stok` (`id_transfer`),
ADD CONSTRAINT `detail_transfer_stok_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`);

ALTER TABLE `packing` 
ADD CONSTRAINT `packing_ibfk_1` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`);

ALTER TABLE `detail_packing` 
ADD CONSTRAINT `detail_packing_ibfk_1` FOREIGN KEY (`id_packing`) REFERENCES `packing` (`id_packing`),
ADD CONSTRAINT `detail_packing_ibfk_2` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`);

ALTER TABLE `log_stok` 
ADD CONSTRAINT `log_stok_ibfk_1` FOREIGN KEY (`id_barang`) REFERENCES `barang` (`id_barang`),
ADD CONSTRAINT `log_stok_ibfk_2` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`),
ADD CONSTRAINT `log_stok_ibfk_3` FOREIGN KEY (`id_perusahaan`) REFERENCES `perusahaan` (`id_perusahaan`),
ADD CONSTRAINT `log_stok_ibfk_4` FOREIGN KEY (`id_gudang`) REFERENCES `gudang` (`id_gudang`);

ALTER TABLE `log_status_transaksi` 
ADD CONSTRAINT `log_status_transaksi_ibfk_1` FOREIGN KEY (`id_user`) REFERENCES `user` (`id_user`);

ALTER TABLE `menu` 
ADD CONSTRAINT `menu_ibfk_1` FOREIGN KEY (`id_parent`) REFERENCES `menu` (`id_menu`);

ALTER TABLE `hak_akses_menu` 
ADD CONSTRAINT `hak_akses_menu_ibfk_1` FOREIGN KEY (`id_role`) REFERENCES `role_user` (`id_role`),
ADD CONSTRAINT `hak_akses_menu_ibfk_2` FOREIGN KEY (`id_menu`) REFERENCES `menu` (`id_menu`);

ALTER TABLE `approval_flow` 
ADD CONSTRAINT `approval_flow_ibfk_1` FOREIGN KEY (`id_role`) REFERENCES `role_user` (`id_role`);

-- Insert Default Roles
INSERT INTO `role_user` (`id_role`, `nama_role`, `deskripsi`) VALUES
(1, 'Super Admin', 'Mengelola semua perusahaan'),
(2, 'Admin Perusahaan', 'Mengelola seluruh data dan transaksi dalam lingkup perusahaannya'),
(3, 'Sales Online', 'Melakukan input penjualan ke konsumen, tidak menyimpan stok'),
(4, 'Admin Packing', 'Menangani proses packing, pengiriman, dan konfirmasi barang sampai'),
(5, 'Admin Return', 'Memproses verifikasi dan approval retur barang');

-- Insert Default Menu
INSERT INTO `menu` (`id_menu`, `nama_menu`, `url`, `icon`, `urutan`, `id_parent`, `status_aktif`) VALUES
(1, 'Dashboard', 'dashboard', 'fas fa-tachometer-alt', 1, NULL, 1),
(2, 'Master Data', '#', 'fas fa-database', 2, NULL, 1),
(3, 'Kategori', 'kategori', 'fas fa-tags', 1, 2, 1),
(4, 'Barang', 'barang', 'fas fa-box', 2, 2, 1),
(5, 'Gudang', 'gudang', 'fas fa-warehouse', 3, 2, 1),
(6, 'Pelanggan', 'pelanggan', 'fas fa-users', 4, 2, 1),
(7, 'Supplier', 'supplier', 'fas fa-truck', 5, 2, 1),
(8, 'User Management', '#', 'fas fa-user-cog', 6, 2, 1),
(9, 'Sales', 'user/sales', 'fas fa-user-tag', 1, 8, 1),
(10, 'Admin Packing', 'user/packing', 'fas fa-user-box', 2, 8, 1),
(11, 'Transaksi', '#', 'fas fa-exchange-alt', 3, NULL, 1),
(12, 'Pembelian', 'pembelian', 'fas fa-shopping-cart', 1, 11, 1),
(13, 'Penerimaan Barang', 'penerimaan', 'fas fa-clipboard-check', 2, 11, 1),
(14, 'Penjualan', 'penjualan', 'fas fa-handshake', 3, 11, 1),
(15, 'Transfer Stok', 'transfer', 'fas fa-truck-loading', 4, 11, 1),
(16, 'Retur', '#', 'fas fa-undo', 5, 11, 1),
(17, 'Retur Penjualan', 'retur/penjualan', 'fas fa-undo-alt', 1, 16, 1),
(18, 'Retur Pembelian', 'retur/pembelian', 'fas fa-undo', 2, 16, 1),
(19, 'Packing', 'packing', 'fas fa-box-open', 6, 11, 1),
(20, 'Laporan', '#', 'fas fa-chart-bar', 4, NULL, 1),
(21, 'Laporan Sales', 'laporan/sales', 'fas fa-chart-line', 1, 20, 1),
(22, 'Laporan Packing', 'laporan/packing', 'fas fa-boxes', 2, 20, 1),
(23, 'Laporan Mutasi', 'laporan/mutasi', 'fas fa-exchange-alt', 3, 20, 1),
(24, 'Laporan Summary', 'laporan/summary', 'fas fa-file-invoice-dollar', 4, 20, 1),
(25, 'Pengaturan', '#', 'fas fa-cog', 5, NULL, 1),
(26, 'Stok Awal', 'pengaturan/stok_awal', 'fas fa-dolly-flatbed', 1, 25, 1),
(27, 'Hak Akses', 'pengaturan/hak_akses', 'fas fa-user-shield', 2, 25, 1),
(28, 'Approval Flow', 'pengaturan/approval', 'fas fa-tasks', 3, 25, 1),
(29, 'Pengaturan Sistem', 'pengaturan/sistem', 'fas fa-sliders-h', 4, 25, 1);

